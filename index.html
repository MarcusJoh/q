<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Q app</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.css">
		<link rel="stylesheet" href="bower_components/animate.css/animate.css">
		<style>
			html {
				position: relative;
				min-height: 100%;
			}
			body {
				padding-top: 70px;
				margin-bottom: 40px;
			}
			.brand-text {
				font-family: monospace;
			}
			.center {
				text-align: center;
			}
			#signup-success-message {
				text-align: center;
				margin-bottom: 24px;
			}
			#signup-success-message span {
				font-size: 36px;
				margin: 20px 0px 24px 0px;
				color: #5CB85C;
			}
			footer {
				position: fixed;
				bottom: 0;
				left: 0;
				width: 100%;
				height: 40px;
				background-color: #f5f5f5;
			}
			footer div{
				padding-top: 10px;
			}
			#page-main{}
			#page-app{display: none;}
			#page-settings{display: none;}



		</style>
	</head>
	<body>

		<!-- MAIN VIEW -->
		<div id="page-main" class="container-fluid">

			<!-- FIXED NAVBAR -->
			<nav class="navbar navbar-default navbar-fixed-top">
				<div class="container">
					<div class="navbar-header">
						<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
							<span class="sr-only">Toggle navigation</span>
							<span class="glyphicon glyphicon-menu-hamburger"></span>
						</button>
						<a class="navbar-brand brand-text" href="#"><strong>Q</strong><small> by ioio</small></a>
					</div>
					<div id="navbar" class="navbar-collapse collapse">
						<ul class="nav navbar-nav navbar-right">
							<li><a href="#signup" data-toggle="modal" data-target="#q-signup-modal"><span class="glyphicon glyphicon-user"></span> Sign Up</a></li>
							<li><a href="#login" data-toggle="modal" data-target="#q-login-modal"><span class="glyphicon glyphicon-log-in"></span> Login</a></li>
						</ul>
					</div><!--/.nav-collapse -->
				</div>
			</nav>

			<!-- PRESENTATION -->
			<div class="jumbotron center">
				<h1 class="brand-text"><strong>Q</strong><small> by ioio</small></h1>
				<br>
				<p>Created by students from Malmö University IxD program.</p>
				<br>
			</div>

			<!-- STICKY FOOTER -->
			<footer>
				<div class="container">
					<p class="text-muted">© 2015 – IOIO/Malmö University</p>
				</div>
			</footer>

			<!-- SIGNUP MODAL -->
			<div id="q-signup-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="signup-modal">
				<div class="modal-dialog modal-sm">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
							<h4 class="modal-title">Sign up</h4>
						</div>
						<div class="modal-body">
							<form>
								<div class="form-group">
									<label class="sr-only" for="signup-firstname">First name</label>
									<input type="text" class="form-control" id="signup-first-name" placeholder="First name">
								</div>
								<div class="form-group">
									<label class="sr-only" for="signup-lastname">Last name</label>
									<input type="text" class="form-control" id="signup-last-name" placeholder="Last name">
								</div>
								<div class="form-group">
									<label class="sr-only" for="signup-course">Course</label>
									<input type="text" class="form-control" id="signup-course" placeholder="Course">
								</div>
								<div class="form-group">
									<label class="sr-only" for="signup-email">Email address</label>
									<input type="email" class="form-control" id="signup-mail" placeholder="Email">
								</div>
								<div class="form-group">
									<label class="sr-only" for="signup-password">Password</label>
									<input type="password" class="form-control" id="signup-password" placeholder="Password">
								</div>
								<div class="form-group form-inline">
									<div class="row">
										<div class="col-xs-8"></div>
										<div class="col-xs-4">
											<button id="signup-button" type="button" class="btn btn-success btn-block"><span class="glyphicon glyphicon-ok"></span></button>
										</div>
									</div>
								</div>
							</form>
							<div id="signup-alert"></div>
						</div>
					</div>
				</div>
			</div>

			<!-- SUCCESS MODAL -->
			<div id="q-success-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="success-modal">
				<div class="modal-dialog modal-sm">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
							<h4 class="modal-title">Success!</h4>
						</div>
						<div class="modal-body">
							<div id="signup-success-message">
								<span class="glyphicon glyphicon-ok animated zoomIn"></span>
								<p>A confirmation message have been sent to your mail.</p>
							</div>
							<form>
								<button id="success-button" data-dismiss="modal" data-toggle="modal" data-target="#q-login-modal" type="button" class="btn btn-default btn-block">Go to login</button>
							</form>
						</div>
					</div>
				</div>
			</div>

			<!-- LOGIN MODAL -->
			<div id="q-login-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="login-modal">
				<div class="modal-dialog modal-sm">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
							<h4 class="modal-title">Login</h4>
						</div>
						<div class="modal-body">
							<form>
								<div class="form-group">
									<label class="sr-only" for="login-email">Email address</label>
									<input type="email" class="form-control" id="login-mail" placeholder="Email">
								</div>
								<div class="form-group">
									<label class="sr-only" for="login-password">Password</label>
									<input type="password" class="form-control" id="login-password" placeholder="Password">
								</div>
								<div class="form-group form-inline">
									<div class="row">
										<div class="col-xs-8">
											<div class="checkbox">
												<label>
													<input id="login-checkbox" type="checkbox"> Remember me
												</label>
											</div>
										</div>
										<div class="col-xs-4">
											<button id="login-button" type="button" class="btn btn-success btn-block"><span class="glyphicon glyphicon-ok"></span></button>
										</div>
									</div>
								</div>
								<button data-dismiss="modal" data-toggle="modal" data-target="#q-signup-modal" type="button" class="btn btn-link btn-block">don't have an account?</button>
							</form>
							<div id="login-alert"></div>
						</div>
					</div>
				</div>
			</div>

		</div><!-- end main view -->

		<!-- APP VIEW -->
		<div id="page-app" class="container-fluid">

			<!-- FIXED NAVBAR-->
			<nav class="navbar navbar-default navbar-fixed-top">
				<div class="container">
					<div class="navbar-header">
						<a class="navbar-brand brand-text" href="#"><strong>Q</strong><small> by ioio</small></a>
					</div>
				</div>
			</nav>

			<!-- CONTENT -->
			<div class="jumbotron">

				<form id="get-help">
					<div class="form-group">
						<div class="row">
							<div class="col-xs-2"></div>
							<div class="col-xs-8">
								<button id="get-help-button" type="button" class="btn btn-success btn-block btn-lg">Need help?</button>
							</div>
							<div class="col-xs-2"></div>
						</div>
					</div>
				</form>

				<form id="end-help">
					<div class="form-group">
						<div class="row">
							<div class="col-xs-2"></div>
							<div class="col-xs-8">
								<button id="end-help-button" type="button" class="btn btn-warning btn-block btn-lg">Step out</button>
							</div>
							<div class="col-xs-2"></div>
						</div>
					</div>
				</form>


			</div>

			<!-- STICKY FOOTER -->
			<footer>
				<div class="container">
					<p class="text-muted">© 2015 – IOIO/Malmö University</p>
				</div>
			</footer>

			<!-- TODO Take-place modal -->
			<!-- TODO Queue modal -->

		</div><!-- end app view -->



		<!-- SETTINGS VIEW -->
		<div id="page-settings" class="container-fluid">
		</div><!-- end app view -->

		<script src="bower_components/jquery/dist/jquery.js" charset="utf-8"></script>
		<script src="bower_components/bootstrap/dist/js/bootstrap.js" charset="utf-8"></script>
		<script src="bower_components/firebase/firebase.js" charset="utf-8"></script>
		<script src="bower_components/knockout/dist/knockout.js" charset="utf-8"></script>

		<script type="text/javascript">

			var firebase = {
				root: undefined,
				users: undefined,
				user: undefined
			};

			var user = {
				name: {
					first: undefined,
					last: undefined
				},
				mail: undefined,
				uid: undefined,
				queue: undefined,
				password: undefined
			};

			//TODO knockout view model
			//TODO deactivate signup/login button while incomplete information

			$(document).ready( function (){
				app.init();
			});

			var app = {
				init: function(){
					firebase.root = new Firebase("https://mah-space-mono.firebaseio.com");
					firebase.users = firebase.root.child("users");
					console.log(firebase.root.toString());
					console.log(firebase.users.toString());
					setButtonListeners();

					/**
						Set a listener on the clients auth state and change views
							depending on if authData is null > main page
							or if authData returns the auth object > app page
						No viewchange necessary in login/logout
					**/
					//TODO move page view change into onAuth callback
					firebase.root.onAuth(function(authData){
						if(authData){
						  console.log("Authenticated user with uid:", authData.uid);
							user.uid = authData.uid;
							//change view here
						} else {
							console.log("No auth");
							//change view here
						}
					});

				},
				signup: function(){
					user.name.first = $("#signup-first-name").val().toLowerCase();
					user.name.last = $("#signup-last-name").val().toLowerCase();
					user.course = $("#signup-course").val().toLowerCase();
					user.mail = $("#signup-mail").val().toLowerCase();
					user.password = $("#signup-password").val();
					//TODO validate this with firebase security instead IF an error message that is clear for the user can be presented
					if(user.name.first === "" || user.mail === "" || user.password === ""){
						displayAlert("#signup-alert","Please fill out all fields","alert-warning");
					} else {
						auth.signup(user.name.first, user.mail, user.password);
					}
				},
				login: function(){
					user.mail = $("#login-mail").val().toLowerCase();
					user.password = $("#login-password").val();
					auth.login(user.mail, user.password);
				},
				logout: function(){
					firebase.root.unauth();
				},
				getTicket: function(){
					firebase.user.update({ticket: Date.now()});
				},
				removeTicket: function(){
					firebase.user.update({ticket: 0});
				}
			}

			var auth = {
				signup: function (name, mail, password){
					console.log("signing up "+name+ "...");
					firebase.root.createUser({
						email    : mail,
						password : password
					}, function(error, userData) {
						if (error) {
							switch (error.code) {
								//TODO shake the signup button with animate.css and display error message
								case "INVALID_EMAIL":
									displayAlert("#signup-alert","The specified user account email is invalid","alert-danger");
									console.log("The specified user account email is invalid.");
									break;
								case "EMAIL_TAKEN":
									displayAlert("#signup-alert","The specified user account email is already taken","alert-warning");
									console.log("The specified user account email is already taken");
									break;
								default:
									var err = "Error signing up user:" + error;
									displayAlert("#signup-alert",err,"alert-danger");
									console.log("Error signing up user:", error);
							}
						} else {
							console.log("Successfully created user account with uid:", userData.uid);
							user.uid = userData.uid;

							//TODO set up a new user in firebase
							firebase.user = firebase.users.child(userData.uid);

							firebase.user.set({
								name: {
									first: user.name.first,
									last: user.name.last
								},
								course: user.course,
								ticket: "0",
								account: "limited"
							});

							//TODO log in user automatically after successfully registration
							$("#q-signup-modal").modal("hide");
							$("#q-success-modal").modal("show");

						}
					});
				},
				login: function(mail,password){
					console.log("logging in...");
					var checkbox = $("#login-checkbox:checked").val();
					var rememberMe;
					if(checkbox === true){
						rememberMe = "default";
					} else {
						rememberMe = "sessionOnly";
					}
					firebase.root.authWithPassword({
					  email: mail,
					  password: password
					}, function(error, authData) {
					  if (error) {
							var err = "Error signing in:" + error;
							displayAlert("#login-alert",err,"alert-danger");
					    console.log("Login Failed!", error);
					  } else {
							console.log("Authenticated successfully with payload:", authData);

							user.uid = authData.uid;
							firebase.user = firebase.users.child(user.uid);
							firebase.user.once("value", function(data){
								if(data.val()){
									user.name.first = data.name.first;
									user.name.last = data.name.last;
									user.course = data.course;
									console.log("found data");
								} else {
									console.log("creating data");
									firebase.user.set({
										name: {
											first: "exampleName",//user.name.first,
											last: "exampleNameLast"//user.name.last
										},
										course: "exampleCourse",//user.course,
										ticket: "0",
										account: "limited"
									});
								}

							});

							queue.setListener();

							$("#q-login-modal").modal("hide");
							$("#page-main").toggle();
							$("#page-app").toggle();
					  }
					},{
						remember: rememberMe
					}
				);
				}
			}



			//TODO validate password
			function validatePassword(){

			}

			function setButtonListeners(){
				$("#signup-button").on("click", app.signup);
				$("#login-button").on("click", app.login);
				$("#get-help-button").on("click", app.getTicket);
				$("#end-help-button").on("click", app.removeTicket);

				//modal enter key
				/*
				$(document).on( "keydown", function(event) {
					if(event.which == 13){
						if ($("#q-signup-modal").is(":visible")) {
						  app.signup;
						} else if ($("#q-login-modal").is(":visible")){
							app.login;
						} else if($("#q-success-modal").is(":visible")){
							$("#q-success-modal").modal("hide");
							$("#q-login-modal").modal("show");
						}

						if($(element).css('display') == 'none' ){
	    				// element is hidden
						}
					}
				});*/
			}

			var queue = {
				arr: [],
				setListener: function(){
					firebase.users.on("value", function(snapshot){
						queue.reset();
						console.log("New queue read");
						snapshot.forEach(function(data){
							if(data.child("ticket").val() != 0 && data.child("ticket").val() !== null){
								//console.log(data.child("ticket").val());
								queue.pushTo(data);
							}
						});
						queue.sortQueue();
						user.queue = queue.findTicket(user.uid);
						queue.draw();
					},function(error){
						console.log("The read failed: " + error.code);
					});
				},
				pushTo: function(obj){
					queue.arr.push({
						/*name: {
							first: obj.child("name/first").val(),
							last: obj.child("name/last").val()
						},*/
						uid: obj.key(),
						ticket: obj.child("ticket").val()
					});
				},
				sortQueue: function(){
					queue.arr.sort(dynamicSort("ticket"));
					//console.log(queue.arr);
				},
				findTicket: function(uid){
					queue.arr.forEach(function(entry, index){
						if(entry.uid === uid){
							return (index + 1);
						} else {
							return 0;
						}
					});
				},
				//TODO draw queue method
				draw: function(){

					/*
					$("#queue-div").empty();
					for(var i = 0; i < queue.arr.length; i++){
						var template = [

						].join("\n");
						$("#queue-div").append(template);
					}*/
				},
				reset: function(){
					queue.arr.length = 0;
				}
			}

			function displayAlert(query, msg, type) {
				var wordArr =["Ops!", "Darn!", "Uh-oh...", "Err.", "Hm...", "It's probably not you, but...", "Ehh...", "Great Scott!", "Well..."];

				$(query).append('<div id="alert-div" class="alert fade in ' + type + '"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button><span><strong>' + wordArr[Math.floor(Math.random() * wordArr.length)] + '</strong> ' + msg + '</span>')

				setTimeout(function() {
					$("#alert-div").remove();
				}, 6000);
			}

			//as found at http://stackoverflow.com/questions/1129216/sort-array-of-objects-by-string-property-value-in-javascript
			//use as: Array.sort(dynamicSort("property"));
			function dynamicSort(property) {
				var sortOrder = 1;
				if(property[0] === "!") {
					sortOrder = -1;
					property = property.substr(1);
				}
				return function (a,b) {
					var result = (a[property] < b[property]) ? -1 : (a[property] > b[property]) ? 1 : 0;
					return result * sortOrder;
				}
			}


			//TODO jquery hasher check so that a user can go directly into their app
			//TODO admin interface
			//TODO password reset button and method

		</script>

	</body>
</html>
